apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

## global namespace must be set due to:
## https://github.com/kubernetes-sigs/kustomize/issues/1301#issuecomment-1308228710
namespace: kubeflow

resources:
  ## upstream
  - upstream/apps/katib/upstream/installs/katib-with-kubeflow

  ## local
  {{<- if tmpl.Exec "kubeflow_katib.mysql.auth.secret_is_cloned" . >}}
  - resources/clone-mysql-secret-clusterpolicy.yaml
  {{<- end >}}
  
  {{<- if not (tmpl.Exec "kubeflow_katib.use_embedded_mysql" .) >}}
  {{<- if not .Values.kubeflow_apps.katib.mysql.auth.existingSecret >}}
  - resources/pipelines-mysql-secret.yaml
  {{<- end >}}
  {{<- end >}}

patchesStrategicMerge:
  - patches/patch-katib-db-manager-deployment.yaml
  - patches/patch-katib-ui-virtualservice.yaml

  ## removals
  - patches/removals/mysql-resources.yaml

configMapGenerator:
  - name: katib-mysql-config
    literals:
      - dbHost="{{< tmpl.Exec "kubeflow_katib.mysql.hostname" . >}}"
      - dbPort="{{< tmpl.Exec "kubeflow_katib.mysql.port" . >}}"
      - dbName="{{< .Values.kubeflow_apps.katib.mysqlDatabase >}}"

images:
  - name: docker.io/kubeflowkatib/katib-controller
    newName: docker.io/kubeflowkatib/katib-controller
    newTag: v0.14.0
  - name: docker.io/kubeflowkatib/katib-db-manager
    newName: docker.io/kubeflowkatib/katib-db-manager
    newTag: v0.14.0
  - name: docker.io/kubeflowkatib/katib-ui
    newName: docker.io/kubeflowkatib/katib-ui
    newTag: v0.14.0
