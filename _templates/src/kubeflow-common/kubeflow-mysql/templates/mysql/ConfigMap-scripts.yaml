apiVersion: v1
kind: ConfigMap
metadata:
  name: kubeflow-mysql-scripts
  labels:
    helm.sh/chart: {{ include "kubeflow-mysql.labels.chart" . }}
    app.kubernetes.io/name: {{ include "kubeflow-mysql.labels.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/component: mysql
data:
  generate_init_file.sh: |
    #!/bin/bash

    set -euo pipefail

    ## DESCRIPTION:
    ## - this script generates the mysql `init_file` to update the root password
    ## - this script is run from the mysql container args, so the `init_file` is re-generated each restart
    ## - we encode the password with base64 so that special characters don't have to be escaped

    PASSWORD_BASE64="$(echo -n "$MYSQL_ROOT_PASSWORD" | base64 -w0)"

    echo "SET @escaped_password = QUOTE(CONVERT(FROM_BASE64('$PASSWORD_BASE64') USING utf8mb4));" > /var/run/mysqld/init.sql
    echo "SET @query_string = CONCAT(\"ALTER USER 'root'@'localhost' IDENTIFIED BY \", @escaped_password);" >> /var/run/mysqld/init.sql
    echo "PREPARE stmt FROM @query_string;" >> /var/run/mysqld/init.sql
    echo "EXECUTE stmt;" >> /var/run/mysqld/init.sql
    echo "DEALLOCATE PREPARE stmt;" >> /var/run/mysqld/init.sql

    echo "successfully generated init_file: /var/run/mysqld/init.sql"
