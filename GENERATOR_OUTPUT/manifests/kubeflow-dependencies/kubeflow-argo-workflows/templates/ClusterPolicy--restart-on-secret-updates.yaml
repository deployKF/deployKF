{{- define "argo-workflows.secret_list__env_vars" }}
## `server.identity.openid` secret
{{- if .Values.server.identity.openid.clientSecret.existingSecret }}
- {{ .Values.server.identity.openid.clientSecret.existingSecret | quote }}
{{- end }}

## `deployKF.pipelines.objectStore.auth` secret
{{- if not .Values.deployKF.pipelines.objectStore.auth.fromEnv }}
- {{ .Values.deployKF_helpers.kubeflow_pipelines.object_store.auth.secret_name | quote }}
{{- end }}
{{- end }}
{{- $secret_list__env_vars := (include "argo-workflows.secret_list__env_vars" .) | fromYamlArray | uniq }}

{{- if $secret_list__env_vars }}
apiVersion: kyverno.io/v2beta1
kind: ClusterPolicy
metadata:
  name: argo-workflows--restart-on-secret-updates
  labels:
    helm.sh/chart: {{ include "kubeflow-argo-workflows.labels.chart" . }}
    app.kubernetes.io/name: {{ include "kubeflow-argo-workflows.labels.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/component: argo
spec:
  mutateExistingOnPolicyUpdate: false
  rules:
    - name: annotate-for-env-var-usage
      match:
        any:
          - resources:
              kinds:
                - Secret
              names: {{ $secret_list__env_vars | toJson }}
              namespaces:
                - {{ .Release.Namespace | quote }}
              operations:
                - CREATE
                - UPDATE
      mutate:
        targets:
          - apiVersion: apps/v1
            kind: Deployment
            namespace: {{ `"{{ request.namespace }}"` }}
        patchStrategicMerge:
          metadata:
            labels:
              <(helm.sh/chart): {{ (include "kubeflow-argo-workflows.labels.chart" .) | quote }}
          spec:
            template:
              metadata:
                annotations:
                  {{ `"secret-version/{{ request.object.metadata.name }}"` }}: {{ `"{{ request.object.metadata.resourceVersion || 'MISSING' }}"` }}
              spec:
                containers:
                  - env:
                      - valueFrom:
                          secretKeyRef:
                            <(name): {{ `"{{ request.object.metadata.name }}"` }}
{{- end }}